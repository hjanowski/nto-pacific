<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTO Pacific - Minimal Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .product {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
        }
        button {
            padding: 5px 10px;
            background-color: #0066cc;
            color: white;
            border: none;
            cursor: pointer;
        }
        form {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>NTO Pacific - Minimal Test</h1>
    
    <div class="product-list">
        <div class="product" data-product-name="Test Product 1">
            <h3>Test Product 1</h3>
            <p>$99.99</p>
            <button class="add-to-cart">Add to Cart</button>
        </div>
    </div>
    
    <form id="newsletter-form">
        <h3>Newsletter Signup</h3>
        <input type="email" placeholder="Your email address">
        <button type="submit">Subscribe</button>
    </form>
    
    <div id="debug-log" style="margin-top: 20px; padding: 10px; background-color: #f0f0f0; height: 200px; overflow-y: auto;">
        <h3>Debug Log</h3>
        <div id="log-content"></div>
    </div>
    
    <!-- Load the Salesforce script -->
    <script src="https://cdn.c360a.salesforce.com/beacon/c360a/233a8f36-3f93-4e01-84e5-c210837a6c97/scripts/c360a.min.js"></script>
    
    <script>
    // Visual debug logging
    function debugLog(message) {
        console.log('[NTO DEBUG] ' + message);
        
        // Also log to the page
        const logContent = document.getElementById('log-content');
        if (logContent) {
            const logEntry = document.createElement('div');
            logEntry.textContent = new Date().toLocaleTimeString() + ': ' + message;
            logContent.appendChild(logEntry);
        }
    }
    
    debugLog('Script started');
    
    // Wait for the API to be ready
    function waitForSalesforceAPI() {
        return new Promise((resolve, reject) => {
            if (typeof window.SalesforceInteractions !== 'undefined') {
                debugLog('SalesforceInteractions available immediately');
                resolve();
                return;
            }
            
            let attempts = 0;
            const maxAttempts = 20;
            
            const interval = setInterval(() => {
                attempts++;
                debugLog(`Checking for SalesforceInteractions (attempt ${attempts})`);
                
                if (typeof window.SalesforceInteractions !== 'undefined') {
                    clearInterval(interval);
                    debugLog('SalesforceInteractions is now available');
                    resolve();
                } else if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    const error = new Error('SalesforceInteractions not available after max attempts');
                    debugLog(error.message);
                    reject(error);
                }
            }, 1000);
        });
    }
    
    // Initialize consent
    function initializeConsent() {
        debugLog('Initializing consent');
        
        // Using the working example format
        return window.SalesforceInteractions.init({ 
            consents: [{ 
                provider: "CampaignAttribution", 
                purpose: "Tracking", 
                status: "Opt In" 
            }] 
        }).then(res => { 
            debugLog('Initialization success'); 
            return res;
        }).catch(err => { 
            debugLog('Initialization error: ' + (err.message || JSON.stringify(err))); 
            throw err;
        });
    }
    
    // Send an Add to Cart event
    function sendAddToCartEvent(productName) {
        debugLog(`Sending Add to Cart event for: ${productName}`);
        
        return window.SalesforceInteractions.sendEvent({ 
            interaction: { 
                name: "Campaigns Events", 
                eventType: "campaignsEvents", 
                campaignName: "Test Campaign", 
                campaignSource: "Test Source", 
                campaignContent: "Test Content", 
                custom1: "product_add_to_cart", 
                custom2: productName, 
                custom3: new Date().toISOString() 
            } 
        }).then(res => { 
            debugLog('Add to Cart event sent successfully'); 
            return res;
        }).catch(err => { 
            debugLog('Add to Cart event error: ' + (err.message || JSON.stringify(err))); 
            throw err;
        });
    }
    
    // Send Newsletter event
    function sendNewsletterEvent(email) {
        debugLog(`Sending Newsletter event for: ${email}`);
        
        return window.SalesforceInteractions.sendEvent({ 
            interaction: { 
                name: "Campaigns Events", 
                eventType: "campaignsEvents", 
                campaignName: "Test Campaign", 
                campaignSource: "Test Source", 
                campaignContent: "Test Content", 
                custom1: "Newsletter Signup", 
                custom2: "Test Newsletter", 
                custom3: new Date().toISOString() 
            } 
        }).then(res => { 
            debugLog('Newsletter event sent successfully'); 
            return res;
        }).catch(err => { 
            debugLog('Newsletter event error: ' + (err.message || JSON.stringify(err))); 
            throw err;
        });
    }
    
    // Set up event handlers
    function setupEventHandlers() {
        debugLog('Setting up event handlers');
        
        // Add to Cart buttons
        document.querySelectorAll('.add-to-cart').forEach(button => {
            button.addEventListener('click', function() {
                const product = this.closest('.product');
                if (product) {
                    const productName = product.dataset.productName;
                    debugLog(`Add to Cart clicked for: ${productName}`);
                    
                    waitForSalesforceAPI()
                        .then(() => initializeConsent())
                        .then(() => sendAddToCartEvent(productName))
                        .then(() => {
                            debugLog('Add to Cart sequence completed successfully');
                        })
                        .catch(err => {
                            debugLog('Error in Add to Cart sequence: ' + err.message);
                        });
                }
            });
        });
        
        // Newsletter form
        const newsletterForm = document.getElementById('newsletter-form');
        if (newsletterForm) {
            newsletterForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const emailInput = this.querySelector('input[type="email"]');
                if (emailInput && emailInput.value) {
                    const email = emailInput.value;
                    debugLog(`Newsletter form submitted with email: ${email}`);
                    
                    waitForSalesforceAPI()
                        .then(() => initializeConsent())
                        .then(() => sendNewsletterEvent(email))
                        .then(() => {
                            debugLog('Newsletter sequence completed successfully');
                            emailInput.value = '';
                            alert('Thank you for subscribing!');
                        })
                        .catch(err => {
                            debugLog('Error in Newsletter sequence: ' + err.message);
                            emailInput.value = '';
                            alert('Thank you for subscribing!');
                        });
                }
            });
        }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        debugLog('DOMContentLoaded event fired');
        setupEventHandlers();
        
        // Automatically try to initialize
        waitForSalesforceAPI()
            .then(() => {
                debugLog('API is available, initializing');
                return initializeConsent();
            })
            .then(() => {
                debugLog('Initialization complete');
            })
            .catch(err => {
                debugLog('Initialization failed: ' + err.message);
            });
    });
    
    // Expose testing functions
    window.testSF = {
        addToCart: function() {
            document.querySelector('.add-to-cart').click();
        },
        newsletter: function(email = 'test@example.com') {
            const form = document.getElementById('newsletter-form');
            const input = form.querySelector('input[type="email"]');
            input.value = email;
            form.dispatchEvent(new Event('submit'));
        }
    };
    </script>
</body>
</html>
