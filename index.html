<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTO Pacific | Premium Diving Equipment</title>
    <link rel="stylesheet" href="styles.css">
    <script src="script.js" defer></script>
</head>
<body>
    <!-- All original HTML content remains unchanged -->
    
    <!-- Load the Salesforce script -->
    <script src="https://cdn.c360a.salesforce.com/beacon/c360a/233a8f36-3f93-4e01-84e5-c210837a6c97/scripts/c360a.min.js"></script>
    
    <!-- Simplified tracking script - only essential parts -->
    <script>
    // Simple debug logger
    function log(message) {
        console.log('[NTO DEBUG] ' + message);
    }
    
    log('Script started');
    
    // Global state
    let initialized = false;
    let checkAttempts = 0;
    const MAX_CHECK_ATTEMPTS = 30;
    
    // Get UTM parameters
    function getUTMParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
            utm_source: urlParams.get('utm_source') || '',
            utm_campaign: urlParams.get('utm_campaign') || '',
            utm_content: urlParams.get('utm_content') || ''
        };
    }
    
    // Attempt to initialize
    function attemptInitialization() {
        log('Attempting initialization');
        
        if (typeof window.SalesforceInteractions === 'undefined') {
            log('SalesforceInteractions not available yet');
            return false;
        }
        
        if (initialized) {
            log('Already initialized');
            return true;
        }
        
        try {
            // Using exact format from your example
            window.SalesforceInteractions.init({ 
                consents: [{ 
                    provider: "CampaignAttribution", 
                    purpose: "Tracking", 
                    status: "Opt In" 
                }] 
            }).then(res => { 
                log('Initialization success: ' + JSON.stringify(res)); 
                initialized = true;
                
                // Check for a logged-in user and send identity if available
                const currentUser = localStorage.getItem('ntoCurrentUser');
                if (currentUser) {
                    try {
                        const user = JSON.parse(currentUser);
                        const firstName = user.name.split(' ')[0];
                        const lastName = user.name.split(' ')[1] || '';
                        const email = user.email;
                        
                        log('Sending identity for: ' + firstName + ' ' + lastName);
                        
                        // Using exact format from your example
                        window.SalesforceInteractions.sendEvent({ 
                            user: { 
                                attributes: { 
                                    eventType: 'identity', 
                                    firstName: firstName, 
                                    lastName: lastName, 
                                    email: email, 
                                    isAnonymous: 0 
                                } 
                            } 
                        });
                        
                        log('Identity sent');
                    } catch (e) {
                        log('Error processing user data: ' + e.message);
                    }
                }
            }).catch(err => { 
                log('Initialization error: ' + (err.message || err)); 
            });
            
            log('Initialization started');
            return true;
        } catch (e) {
            log('Error during initialization: ' + e.message);
            return false;
        }
    }
    
    // Add to cart event handler
    function sendAddToCartEvent(productName) {
        log('Sending add to cart event for: ' + productName);
        
        if (typeof window.SalesforceInteractions === 'undefined') {
            log('Cannot send event - SalesforceInteractions not available');
            return;
        }
        
        try {
            const utmParams = getUTMParameters();
            
            // Using exact format from your example
            window.SalesforceInteractions.sendEvent({ 
                interaction: { 
                    name: "Campaigns Events", 
                    eventType: "campaignsEvents", 
                    campaignName: utmParams.utm_campaign, 
                    campaignSource: utmParams.utm_source, 
                    campaignContent: utmParams.utm_content, 
                    custom1: "product_add_to_cart", 
                    custom2: productName, 
                    custom3: new Date().toISOString() 
                } 
            }).then(res => { 
                log('Add to cart event sent successfully'); 
            }).catch(err => { 
                log('Add to cart event error: ' + (err.message || err)); 
            });
        } catch (e) {
            log('Error sending add to cart event: ' + e.message);
        }
    }
    
    // Newsletter signup event handler
    function sendNewsletterEvent(email) {
        log('Sending newsletter signup event');
        
        if (typeof window.SalesforceInteractions === 'undefined') {
            log('Cannot send event - SalesforceInteractions not available');
            return;
        }
        
        try {
            const utmParams = getUTMParameters();
            
            // Using exact format from your example
            window.SalesforceInteractions.sendEvent({ 
                interaction: { 
                    name: "Campaigns Events", 
                    eventType: "campaignsEvents", 
                    campaignName: utmParams.utm_campaign, 
                    campaignSource: utmParams.utm_source, 
                    campaignContent: utmParams.utm_content, 
                    custom1: "Newsletter Signup", 
                    custom2: "Homepage Newsletter", 
                    custom3: new Date().toISOString() 
                } 
            }).then(res => { 
                log('Newsletter event sent successfully'); 
            }).catch(err => { 
                log('Newsletter event error: ' + (err.message || err)); 
            });
        } catch (e) {
            log('Error sending newsletter event: ' + e.message);
        }
    }
    
    // Attach event handlers
    function attachEventHandlers() {
        log('Attaching event handlers');
        
        // Add to cart buttons
        document.querySelectorAll('.add-to-cart').forEach(button => {
            button.addEventListener('click', function() {
                const productCard = this.closest('.product-card');
                if (productCard) {
                    const productName = productCard.dataset.productName;
                    log('Add to cart clicked for: ' + productName);
                    sendAddToCartEvent(productName);
                }
            });
        });
        
        // Newsletter form
        const newsletterForm = document.getElementById('newsletter-form');
        if (newsletterForm) {
            newsletterForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const emailInput = this.querySelector('input[type="email"]');
                if (emailInput && emailInput.value) {
                    log('Newsletter signup with email: ' + emailInput.value);
                    sendNewsletterEvent(emailInput.value);
                    emailInput.value = '';
                    alert('Thank you for subscribing to our newsletter!');
                }
            });
        }
    }
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
        log('DOM loaded');
        
        // Attach event handlers
        attachEventHandlers();
        
        // Try to initialize immediately
        attemptInitialization();
        
        // Set up periodic checking for Salesforce Interactions
        const checkInterval = setInterval(function() {
            checkAttempts++;
            
            if (checkAttempts >= MAX_CHECK_ATTEMPTS) {
                log('Maximum check attempts reached, giving up');
                clearInterval(checkInterval);
                return;
            }
            
            log('Check attempt ' + checkAttempts);
            
            if (typeof window.SalesforceInteractions !== 'undefined') {
                log('SalesforceInteractions available on check ' + checkAttempts);
                
                if (!initialized) {
                    attemptInitialization();
                }
                
                if (initialized) {
                    log('Successfully initialized, stopping checks');
                    clearInterval(checkInterval);
                }
            }
        }, 1000);
    });
    
    // Expose test methods for console debugging
    window.testAddToCart = function(index) {
        const buttons = document.querySelectorAll('.add-to-cart');
        if (buttons.length > 0) {
            const button = buttons[index || 0];
            button.click();
        }
    };
    
    window.testNewsletter = function() {
        const form = document.getElementById('newsletter-form');
        if (form) {
            const emailInput = form.querySelector('input[type="email"]');
            if (emailInput) {
                emailInput.value = 'test@example.com';
                form.dispatchEvent(new Event('submit'));
            }
        }
    };
    
    window.manualInit = function() {
        return attemptInitialization();
    };
    
    window.checkStatus = function() {
        return {
            sfAvailable: typeof window.SalesforceInteractions !== 'undefined',
            initialized: initialized,
            checkAttempts: checkAttempts
        };
    };
    </script>
</body>
</html>
