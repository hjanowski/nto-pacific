<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTO Pacific | Premium Diving Equipment</title>
    <link rel="stylesheet" href="styles.css">
    <script src="script.js" defer></script>
</head>
<body>
    <!-- Your existing HTML content remains unchanged - omitted for brevity -->
    
    <!-- Load the Salesforce script -->
    <script src="https://cdn.c360a.salesforce.com/beacon/c360a/233a8f36-3f93-4e01-84e5-c210837a6c97/scripts/c360a.min.js"></script>
    
    <script>
    // Simple debug function to make logs more visible
    function debugLog(message) {
        console.log('%c[NTO DEBUG] ' + message, 'background: #f0f0f0; color: #0a66c2; font-weight: bold; padding: 3px 5px; border-radius: 3px;');
    }

    // Test logging
    debugLog('Script started - console logging is working');
    
    // Define getUTMParameters globally
    function getUTMParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
            utm_source: urlParams.get('utm_source') || '',
            utm_campaign: urlParams.get('utm_campaign') || '',
            utm_content: urlParams.get('utm_content') || ''
        };
    }
    
    // Track if we've initialized
    let isInitialized = false;
    
    // Wait for the API to be ready - this function returns a Promise
    function waitForSalesforceAPI() {
        return new Promise((resolve, reject) => {
            // Check if already available
            if (typeof window.SalesforceInteractions !== 'undefined' && 
                typeof window.SalesforceInteractions.sendEvent === 'function') {
                debugLog('SalesforceInteractions API is immediately available');
                resolve();
                return;
            }
            
            debugLog('Waiting for SalesforceInteractions API...');
            
            // Set up polling
            let attempts = 0;
            const maxAttempts = 30;
            const interval = setInterval(() => {
                attempts++;
                
                if (typeof window.SalesforceInteractions !== 'undefined' && 
                    typeof window.SalesforceInteractions.sendEvent === 'function') {
                    clearInterval(interval);
                    debugLog(`SalesforceInteractions API is available after ${attempts} attempts`);
                    resolve();
                } else if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    const error = new Error(`SalesforceInteractions API not available after ${maxAttempts} attempts`);
                    debugLog(error.message);
                    reject(error);
                }
            }, 500);
        });
    }
    
    // Initialize consent using the format that worked
    function initializeConsent() {
        if (isInitialized) {
            debugLog('Already initialized');
            return Promise.resolve();
        }
        
        debugLog('Initializing SalesforceInteractions consent...');
        
        // Using exact format from the working example
        return window.SalesforceInteractions.init({ 
            consents: [{ 
                provider: "CampaignAttribution", 
                purpose: "Tracking", 
                status: "Opt In" 
            }] 
        }).then(res => { 
            debugLog('Initialization success: ' + JSON.stringify(res)); 
            isInitialized = true;
            return res;
        }).catch(err => { 
            debugLog('Initialization error: ' + JSON.stringify(err)); 
            throw err;
        });
    }
    
    // Send identity if user is logged in
    function sendIdentityIfLoggedIn() {
        const currentUser = localStorage.getItem('ntoCurrentUser');
        if (!currentUser) {
            debugLog('No logged in user found, skipping identity event');
            return Promise.resolve();
        }
        
        try {
            const parsedUser = JSON.parse(currentUser);
            const firstName = parsedUser.name.split(' ')[0];
            const lastName = parsedUser.name.split(' ')[1] || '';
            const email = parsedUser.email;
            
            debugLog(`Sending identity event for user: ${firstName} ${lastName}`);
            
            // Using exact format from the working example
            return window.SalesforceInteractions.sendEvent({ 
                user: { 
                    attributes: { 
                        eventType: 'identity', 
                        firstName: firstName, 
                        lastName: lastName, 
                        email: email, 
                        isAnonymous: 0 
                    } 
                } 
            }).then(() => {
                debugLog('Identity event sent successfully');
            }).catch(err => {
                debugLog('Identity event error: ' + JSON.stringify(err));
                throw err;
            });
        } catch (error) {
            debugLog('Error processing user data: ' + error.message);
            return Promise.reject(error);
        }
    }
    
    // Send an "Add to Cart" event
    function sendAddToCartEvent(productName) {
        const utmParams = getUTMParameters();
        
        debugLog(`Sending "Add to Cart" event for product: ${productName}`);
        debugLog('UTM Parameters: ' + JSON.stringify(utmParams));
        
        // Using exact format from the working example
        return window.SalesforceInteractions.sendEvent({ 
            interaction: { 
                name: "Campaigns Events", 
                eventType: "campaignsEvents", 
                campaignName: utmParams.utm_campaign, 
                campaignSource: utmParams.utm_source, 
                campaignContent: utmParams.utm_content, 
                custom1: "product_add_to_cart", 
                custom2: productName, 
                custom3: new Date().toISOString() 
            } 
        }).then(res => { 
            debugLog('Add to Cart event sent successfully: ' + JSON.stringify(res)); 
            return res;
        }).catch(err => { 
            debugLog('Add to Cart event error: ' + JSON.stringify(err)); 
            throw err;
        });
    }
    
    // Send a "Newsletter Signup" event
    function sendNewsletterEvent(email) {
        const utmParams = getUTMParameters();
        
        debugLog(`Sending "Newsletter Signup" event for email: ${email}`);
        debugLog('UTM Parameters: ' + JSON.stringify(utmParams));
        
        // Using exact format from the working example
        return window.SalesforceInteractions.sendEvent({ 
            interaction: { 
                name: "Campaigns Events", 
                eventType: "campaignsEvents", 
                campaignName: utmParams.utm_campaign, 
                campaignSource: utmParams.utm_source, 
                campaignContent: utmParams.utm_content, 
                custom1: "Newsletter Signup", 
                custom2: "Homepage Newsletter", 
                custom3: new Date().toISOString() 
            } 
        }).then(res => { 
            debugLog('Newsletter event sent successfully: ' + JSON.stringify(res)); 
            return res;
        }).catch(err => { 
            debugLog('Newsletter event error: ' + JSON.stringify(err)); 
            throw err;
        });
    }
    
    // Attach event handlers for user interactions
    function setupEventHandlers() {
        debugLog('Setting up event handlers');
        
        // Add to Cart buttons
        document.querySelectorAll('.add-to-cart').forEach((button, index) => {
            debugLog(`Setting up handler for Add to Cart button #${index + 1}`);
            
            button.addEventListener('click', function() {
                const productCard = this.closest('.product-card');
                if (productCard) {
                    const productName = productCard.dataset.productName;
                    debugLog(`Add to Cart clicked for: ${productName}`);
                    
                    // Always ensure we're initialized before sending events
                    waitForSalesforceAPI()
                        .then(() => initializeConsent())
                        .then(() => sendAddToCartEvent(productName))
                        .catch(err => {
                            debugLog('Error during Add to Cart event processing: ' + err.message);
                        });
                }
            });
        });
        
        // Newsletter form
        const newsletterForm = document.getElementById('newsletter-form');
        if (newsletterForm) {
            debugLog('Setting up handler for Newsletter form');
            
            newsletterForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const emailInput = this.querySelector('input[type="email"]');
                if (emailInput && emailInput.value) {
                    const email = emailInput.value;
                    debugLog(`Newsletter signup with email: ${email}`);
                    
                    // Always ensure we're initialized before sending events
                    waitForSalesforceAPI()
                        .then(() => initializeConsent())
                        .then(() => sendNewsletterEvent(email))
                        .then(() => {
                            // Clear the form and show confirmation
                            emailInput.value = '';
                            alert('Thank you for subscribing to our newsletter!');
                        })
                        .catch(err => {
                            debugLog('Error during Newsletter event processing: ' + err.message);
                            // Still show confirmation even if event fails
                            emailInput.value = '';
                            alert('Thank you for subscribing to our newsletter!');
                        });
                }
            });
        } else {
            debugLog('WARNING: Newsletter form not found!');
        }
    }
    
    // Initialize everything when the document is ready
    document.addEventListener('DOMContentLoaded', function() {
        debugLog('DOM content loaded, starting initialization');
        
        // Set up event handlers
        setupEventHandlers();
        
        // Start the API initialization process
        waitForSalesforceAPI()
            .then(() => {
                debugLog('SalesforceInteractions API is ready, initializing consent');
                return initializeConsent();
            })
            .then(() => {
                debugLog('Consent initialized, checking for logged in user');
                return sendIdentityIfLoggedIn();
            })
            .then(() => {
                debugLog('Initialization complete, ready for events');
            })
            .catch(err => {
                debugLog('Error during initialization: ' + err.message);
            });
    });
    
    // Expose debugging functions to the console
    window.debugSF = {
        checkAPI: function() {
            return typeof window.SalesforceInteractions !== 'undefined' && 
                   typeof window.SalesforceInteractions.sendEvent === 'function';
        },
        initialize: function() {
            return waitForSalesforceAPI()
                .then(() => initializeConsent())
                .then(() => sendIdentityIfLoggedIn());
        },
        testAddToCart: function(index = 0) {
            const buttons = document.querySelectorAll('.add-to-cart');
            if (buttons.length > 0) {
                buttons[index].click();
                return true;
            }
            return false;
        },
        testNewsletter: function(email = 'test@example.com') {
            const form = document.getElementById('newsletter-form');
            if (form) {
                const emailInput = form.querySelector('input[type="email"]');
                if (emailInput) {
                    emailInput.value = email;
                    form.dispatchEvent(new Event('submit'));
                    return true;
                }
            }
            return false;
        }
    };
    
    debugLog('Script setup complete');
    </script>
</body>
</html>
